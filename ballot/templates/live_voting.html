{% extends "layouts/base.html" %}
{% block title %} Live Voting {% endblock %}
{% block styles %}
<style>
a.disabled {
    pointer-events: none;
    color: #ccc;
}
td.status {
  font-size: 20px;
  padding-left: 2rem;
}
td.status > .dropdown-icon {
  margin-left: 1rem;
  margin-right: 0.5rem;
}
</style>
{% endblock %}
{% block content %}
<div class="my-12 my-md-12">
  <div class="container">
    <div class="page-header">
      <h1 class="page-title">
        {{ poll_details.title }} Batch No. {{ poll_details.batch_no }} <a href="{% url 'ballot:start_next_batch' poll_details.id %}" target="_self" class="btn btn-outline-secondary"><i class="dropdown-icon fe fe-plus"></i><b>Start Next Batch</b></a>
      </h1>
    </div>
    <div class="row row-cards row-deck">
      <div class="col-12">
        <div class="card">
          <div class="table-responsive">
            <table class="table table-hover table-outline table-vcenter text-nowrap card-table">
              <thead>
                <tr>
                  <th>Item</th>
                  <th class="text-center">Voting Status</th>
                  <th class="text-center">Action</th>
                </tr>
              </thead>
              <tbody>
                {% for item in poll_details.items %}
                <tr>
                  <td>
                    <div>{{ forloop.counter }}. {{ item.text }} (By {% if item.type == 1 %}Share{% endif %}{% if item.type == 2 %}Lot{% endif %})</div>
                  </td>
                  <td class="text-left status">
                    <i class="dropdown-icon fa fa-smile-o"></i>{{ item.result.for }}({{ item.result.for_addon }})
                    <i class="dropdown-icon fa fa-meh-o"></i>{{ item.result.abstain }}({{ item.result.abstain_addon }})
                    <i class="dropdown-icon fa fa-frown-o"></i>{{ item.result.against }}({{ item.result.against_addon }})
                    &nbsp;&nbsp;
                    <i class="dropdown-icon fa fa-user-times"></i>{{ item.result.miss }}&nbsp;({{ item.addon }})
                  </td>
                  <td class="text-center">
                    {% if item.is_open %}
                    <a href="{% url 'ballot:close_live_voting' item.id %}" target="_self" class="dropdown-item"><i class="dropdown-icon fe fe-disc"></i><b>Close Voting</b></a>
                    {% else %}
                    <a href="{% url 'ballot:open_live_voting' item.id %}" target="_self" class="dropdown-item {% if has_voting_opened %}disabled{% endif %}"><i class="dropdown-icon fe fe-check-circle"></i>Open Voting</a>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}
<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<script type="text/javascript">
  require(['jquery'], function () {
    $(".nav-link").removeClass("active");
    $(".nav-link.live_voting").addClass("active");

    {% if has_voting_opened %}
    var need_to_reload = false;
    var check_seconds_left = setInterval(function() {
      $.get("{% url 'ballot:live_voting_openning_json' %}",
        function(ret) {
          // console.log("live_voting", ret);
          var opening_seconds_left = parseInt(ret["opening_seconds_left"], 10);
          $("#time_label").text("Time Left: " + opening_seconds_left + " seconds");
          if (opening_seconds_left > 0) {
            need_to_reload = true;
          }
          else if (opening_seconds_left == 0) {
            window.location.reload(true);
          }
          else if (opening_seconds_left == -1) {
            if (need_to_reload) {
              window.location.reload(true);
            }
            else {
              clearInterval(check_seconds_left);
            }
          }
        }
      );
    }, 1000);
    {% endif %}
  });
</script>
{% endblock javascripts %}